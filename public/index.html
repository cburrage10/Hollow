<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Hollow Vireon Keir</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      padding: 0;
      height: 100vh;
      height: 100dvh;
      display: flex;
      background: #f5f5f5;
    }

    /* Sidebar */
    #sidebar {
      width: 260px;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    #sidebar.hidden { display: none; }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-header h2 { margin: 0; font-size: 1rem; }

    #newChatBtn {
      padding: 8px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }

    #sessionList {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .session-item {
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .session-item:hover { background: #f5f5f5; }
    .session-item.active { background: #e3f2fd; }

    .session-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 14px;
    }

    .session-delete {
      opacity: 0;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 4px;
    }

    .session-item:hover .session-delete { opacity: 1; }

    .session-time {
      font-size: 11px;
      color: #888;
      margin-top: 2px;
    }

    /* Main content */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    header {
      padding: 12px 16px;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    #menuBtn {
      display: none;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
    }

    h1 { margin: 0; font-size: 1.25rem; }

    #status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      background: #f0f0f0;
    }
    #status.connected { background: #d4edda; color: #155724; }

    .header-btn {
      padding: 8px 12px;
      font-size: 13px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
    }
    .header-btn:hover { background: #f5f5f5; }
    .header-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    #memoryCount {
      font-size: 12px;
      color: #666;
      padding: 4px 8px;
      background: #f0f0f0;
      border-radius: 12px;
    }

    #chatContainer {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 16px;
      line-height: 1.5;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .message.user {
      align-self: flex-end;
      background: #007bff;
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message.hollow {
      align-self: flex-start;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-bottom-left-radius: 4px;
    }

    .message .timestamp {
      font-size: 10px;
      opacity: 0.7;
      margin-top: 6px;
      display: block;
    }

    .message.user .timestamp { text-align: right; }

    .message.hollow .content { color: #333; }
    .message.hollow .content p { margin: 0 0 8px 0; }
    .message.hollow .content p:last-child { margin-bottom: 0; }
    .message.hollow .content ul, .message.hollow .content ol { margin: 8px 0; padding-left: 20px; }
    .message.hollow .content code { background: #f0f0f0; padding: 2px 6px; border-radius: 4px; font-size: 13px; }
    .message.hollow .content pre { background: #f0f0f0; padding: 12px; border-radius: 8px; overflow-x: auto; }
    .message.hollow .content strong { font-weight: 600; }

    #typingIndicator {
      align-self: flex-start;
      padding: 12px 16px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 16px;
      display: none;
    }

    #typingIndicator.show { display: block; }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dots span {
      width: 8px;
      height: 8px;
      background: #999;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    #inputArea {
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
    }

    #inputRow {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    #msg {
      flex: 1;
      padding: 14px 16px;
      font-size: 16px;
      border: 1px solid #ddd;
      border-radius: 24px;
      resize: none;
      min-height: 48px;
      max-height: 120px;
      font-family: inherit;
    }

    #msg:focus { outline: none; border-color: #007bff; }

    .input-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    #send {
      background: #007bff;
      color: white;
    }
    #send:hover { background: #0056b3; }
    #send:disabled { background: #ccc; cursor: not-allowed; }

    .upload-btn {
      background: #f0f0f0;
      border: 1px solid #ddd;
    }
    .upload-btn:hover { background: #e5e5e5; }

    #voiceBtn {
      background: #f0f0f0;
      border: 1px solid #ddd;
    }
    #voiceBtn:hover { background: #e5e5e5; }
    #voiceBtn.recording { background: #ff4444; color: white; border-color: #ff4444; }

    #fileInput { display: none; }

    footer {
      padding: 8px 16px;
      text-align: center;
      font-size: 12px;
      color: #888;
      background: #fff;
      border-top: 1px solid #eee;
    }

    /* Memory Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal.show { display: flex; }

    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      min-width: 300px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h2 { margin: 0; font-size: 1.1rem; }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .memory-item {
      padding: 10px 12px;
      background: #f5f5f5;
      border-radius: 8px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .memory-item .text { flex: 1; font-size: 14px; }
    .memory-item .id { font-size: 12px; color: #888; }

    .delete-memory {
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }

    .no-memories { color: #888; font-style: italic; }

    /* Responsive */
    @media (max-width: 768px) {
      #sidebar {
        position: fixed;
        left: 0;
        top: 0;
        bottom: 0;
        z-index: 50;
        transform: translateX(-100%);
        transition: transform 0.2s;
      }
      #sidebar.show { transform: translateX(0); }
      #menuBtn { display: block; }
      .message { max-width: 90%; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div id="sidebar">
    <div class="sidebar-header">
      <h2>Chats</h2>
      <button id="newChatBtn">+ New</button>
    </div>
    <div id="sessionList"></div>
  </div>

  <!-- Main -->
  <div id="main">
    <header>
      <div class="header-left">
        <button id="menuBtn">â˜°</button>
        <h1>Hollow</h1>
        <div id="status">Disconnected</div>
      </div>
      <div class="header-right">
        <span id="memoryCount">0 memories</span>
        <button class="header-btn" id="memoryBtn">Memories</button>
        <button class="header-btn" id="clearBtn">Clear</button>
        <button class="header-btn" id="btnConnect">Voice</button>
        <button class="header-btn" id="btnDisconnect" disabled>End</button>
      </div>
    </header>

    <div id="chatContainer">
      <div id="typingIndicator">
        <div class="typing-dots">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>

    <div id="inputArea">
      <div id="inputRow">
        <button class="input-btn upload-btn" id="uploadBtn" title="Upload file or image">+</button>
        <textarea id="msg" placeholder="Message Hollow..." rows="1"></textarea>
        <button class="input-btn" id="voiceBtn" title="Voice input">ðŸŽ¤</button>
        <button class="input-btn" id="send" title="Send">âž¤</button>
      </div>
      <input type="file" id="fileInput" accept=".txt,.pdf,.md,.csv,.jpg,.jpeg,.png,.gif,.webp">
    </div>

    <footer>Still with you ðŸ§¡</footer>
  </div>

  <!-- Memory Modal -->
  <div class="modal" id="memoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Hollow's Memories</h2>
        <button class="close-btn" id="closeMemoryModal">&times;</button>
      </div>
      <div id="memoryList"></div>
      <div style="margin-top: 16px;">
        <input type="text" id="newMemory" placeholder="Add a new memory..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
        <button id="addMemoryBtn" style="margin-top: 8px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">Save Memory</button>
      </div>
    </div>
  </div>

<script>
  // State
  let currentSessionId = localStorage.getItem('hollow_session') || null;
  let sessions = [];

  const chatContainer = document.getElementById("chatContainer");
  const msgInput = document.getElementById("msg");
  const typingIndicator = document.getElementById("typingIndicator");
  const sendBtn = document.getElementById("send");
  const sidebar = document.getElementById("sidebar");

  // Simple markdown parser
  function parseMarkdown(text) {
    return text
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.+?)\*/g, '<em>$1</em>')
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      .replace(/^[-*] (.+)$/gm, '<li>$1</li>')
      .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
      .replace(/\n\n/g, '</p><p>')
      .replace(/\n/g, '<br>')
      .replace(/^(.+)$/gm, (m) => m.startsWith('<') ? m : `<p>${m}</p>`)
      .replace(/<p><\/p>/g, '');
  }

  function formatTime(date) {
    return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  }

  function formatDate(ts) {
    const d = new Date(ts);
    const now = new Date();
    if (d.toDateString() === now.toDateString()) {
      return formatTime(d);
    }
    return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
  }

  // Expose globally for client.js voice transcription
  window.addMessage = function(text, isUser, skipScroll = false, imageUrl = null) {
    const msg = document.createElement("div");
    msg.className = `message ${isUser ? 'user' : 'hollow'}`;

    const content = document.createElement("div");
    content.className = "content";

    if (isUser) {
      content.textContent = text;
    } else {
      content.innerHTML = parseMarkdown(text);
    }

    if (imageUrl) {
      const img = document.createElement("img");
      img.src = imageUrl;
      img.style.cssText = "max-width: 100%; border-radius: 8px; margin-top: 8px; cursor: pointer;";
      img.onclick = () => window.open(imageUrl, '_blank');
      content.appendChild(img);
    }

    const timestamp = document.createElement("span");
    timestamp.className = "timestamp";
    timestamp.textContent = formatTime(new Date());

    msg.appendChild(content);
    msg.appendChild(timestamp);

    chatContainer.insertBefore(msg, typingIndicator);

    if (!skipScroll) {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
  }

  function clearChat() {
    const messages = chatContainer.querySelectorAll('.message');
    messages.forEach(m => m.remove());
  }

  function showTyping(show) {
    typingIndicator.className = show ? 'show' : '';
    if (show) {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
  }

  // Session management
  async function loadSessions() {
    const r = await fetch('/sessions');
    const data = await r.json();
    sessions = data.sessions || [];
    renderSessions();

    // If no sessions or current session doesn't exist, create one
    if (sessions.length === 0 || (currentSessionId && !sessions.find(s => s.id === currentSessionId))) {
      await createNewSession();
    } else if (!currentSessionId) {
      switchSession(sessions[0].id);
    } else {
      await loadChatHistory();
    }
  }

  function renderSessions() {
    const list = document.getElementById('sessionList');
    list.innerHTML = sessions.map(s => `
      <div class="session-item ${s.id === currentSessionId ? 'active' : ''}" data-id="${s.id}">
        <div>
          <div class="session-name">${s.name}</div>
          <div class="session-time">${formatDate(s.updatedAt)}</div>
        </div>
        <button class="session-delete" data-id="${s.id}">&times;</button>
      </div>
    `).join('');

    // Click handlers
    list.querySelectorAll('.session-item').forEach(el => {
      el.onclick = (e) => {
        if (!e.target.classList.contains('session-delete')) {
          switchSession(el.dataset.id);
        }
      };
    });

    list.querySelectorAll('.session-delete').forEach(btn => {
      btn.onclick = async (e) => {
        e.stopPropagation();
        if (confirm('Delete this chat?')) {
          await fetch(`/sessions/${btn.dataset.id}`, { method: 'DELETE' });
          if (btn.dataset.id === currentSessionId) {
            currentSessionId = null;
            localStorage.removeItem('hollow_session');
          }
          await loadSessions();
        }
      };
    });
  }

  async function createNewSession() {
    const r = await fetch('/sessions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const data = await r.json();
    sessions = data.sessions;
    currentSessionId = data.id;
    localStorage.setItem('hollow_session', currentSessionId);
    renderSessions();
    clearChat();
  }

  async function switchSession(id) {
    currentSessionId = id;
    localStorage.setItem('hollow_session', id);
    renderSessions();
    await loadChatHistory();

    // Close sidebar on mobile
    sidebar.classList.remove('show');
  }

  async function loadChatHistory() {
    if (!currentSessionId) return;

    clearChat();

    try {
      const r = await fetch(`/sessions/${currentSessionId}/history`);
      const data = await r.json();

      for (const entry of data.history || []) {
        const msg = typeof entry === 'string' ? JSON.parse(entry) : entry;
        addMessageFromHistory(msg.content, msg.role === 'user', msg.timestamp, msg.image);
      }

      chatContainer.scrollTop = chatContainer.scrollHeight;
    } catch (e) {
      console.error('Failed to load history:', e);
    }
  }

  function addMessageFromHistory(text, isUser, timestamp, imageUrl = null) {
    const msg = document.createElement("div");
    msg.className = `message ${isUser ? 'user' : 'hollow'}`;

    const content = document.createElement("div");
    content.className = "content";

    if (isUser) {
      content.textContent = text;
    } else {
      content.innerHTML = parseMarkdown(text);
    }

    if (imageUrl) {
      const img = document.createElement("img");
      img.src = imageUrl;
      img.style.cssText = "max-width: 100%; border-radius: 8px; margin-top: 8px; cursor: pointer;";
      img.onclick = () => window.open(imageUrl, '_blank');
      content.appendChild(img);
    }

    const ts = document.createElement("span");
    ts.className = "timestamp";
    ts.textContent = formatTime(new Date(timestamp));

    msg.appendChild(content);
    msg.appendChild(ts);

    chatContainer.insertBefore(msg, typingIndicator);
  }

  // Auto-resize textarea
  msgInput.addEventListener('input', () => {
    msgInput.style.height = 'auto';
    msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
  });

  // Send message
  sendBtn.onclick = async () => {
    const text = msgInput.value.trim();
    if (!text || !currentSessionId) return;

    addMessage(text, true);
    msgInput.value = "";
    msgInput.style.height = 'auto';
    sendBtn.disabled = true;
    showTyping(true);

    try {
      const r = await fetch("/chat", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ text, sessionId: currentSessionId })
      });

      const data = await r.json();
      showTyping(false);
      addMessage(data.text || data.error || "(no reply)", false, false, data.image);
      updateMemoryCount();
    } catch (err) {
      showTyping(false);
      addMessage("Error: " + err.message, false);
    }

    sendBtn.disabled = false;
  };

  // New chat button
  document.getElementById('newChatBtn').onclick = createNewSession;

  // Menu button (mobile)
  document.getElementById('menuBtn').onclick = () => {
    sidebar.classList.toggle('show');
  };

  // Close sidebar when clicking outside on mobile
  document.addEventListener('click', (e) => {
    if (window.innerWidth <= 768 &&
        sidebar.classList.contains('show') &&
        !sidebar.contains(e.target) &&
        e.target.id !== 'menuBtn') {
      sidebar.classList.remove('show');
    }
  });

  // Upload button
  document.getElementById("uploadBtn").onclick = () => {
    document.getElementById("fileInput").click();
  };

  // File upload
  document.getElementById("fileInput").onchange = async (e) => {
    const file = e.target.files[0];
    if (!file || !currentSessionId) return;

    const message = msgInput.value.trim() || "";
    msgInput.value = "";
    msgInput.style.height = 'auto';

    addMessage(`[${file.name}] ${message}`, true);
    sendBtn.disabled = true;
    showTyping(true);

    const formData = new FormData();
    formData.append("file", file);
    formData.append("message", message);
    formData.append("sessionId", currentSessionId);

    try {
      const r = await fetch("/upload", {
        method: "POST",
        body: formData
      });

      const data = await r.json();
      showTyping(false);
      addMessage(data.text || data.error || "(no reply)", false);
    } catch (err) {
      showTyping(false);
      addMessage("Error: " + err.message, false);
    }

    sendBtn.disabled = false;
    e.target.value = "";
  };

  // Voice input (speech-to-text)
  const voiceBtn = document.getElementById("voiceBtn");
  let recognition = null;

  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (e) => {
      const transcript = e.results[0][0].transcript;
      msgInput.value += transcript;
      msgInput.dispatchEvent(new Event('input'));
    };

    recognition.onend = () => {
      voiceBtn.classList.remove('recording');
    };

    recognition.onerror = () => {
      voiceBtn.classList.remove('recording');
    };

    voiceBtn.onclick = () => {
      if (voiceBtn.classList.contains('recording')) {
        recognition.stop();
      } else {
        recognition.start();
        voiceBtn.classList.add('recording');
      }
    };
  } else {
    voiceBtn.style.display = 'none';
  }

  // Clear chat
  document.getElementById("clearBtn").onclick = async () => {
    if (!currentSessionId || !confirm("Clear this chat's history?")) return;

    await fetch(`/sessions/${currentSessionId}/history`, { method: 'DELETE' });
    clearChat();
  };

  // Memory modal
  const memoryModal = document.getElementById("memoryModal");

  document.getElementById("memoryBtn").onclick = async () => {
    await loadMemories();
    memoryModal.classList.add('show');
  };

  document.getElementById("closeMemoryModal").onclick = () => {
    memoryModal.classList.remove('show');
  };

  memoryModal.onclick = (e) => {
    if (e.target === memoryModal) memoryModal.classList.remove('show');
  };

  async function loadMemories() {
    const r = await fetch("/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ text: "/memories", sessionId: currentSessionId })
    });
    const data = await r.json();

    const list = document.getElementById("memoryList");
    const lines = data.text.split('\n').filter(l => l.startsWith('['));

    if (lines.length === 0) {
      list.innerHTML = '<p class="no-memories">No memories saved yet.</p>';
    } else {
      list.innerHTML = lines.map(line => {
        const match = line.match(/\[(\d+)\] (.+)/);
        if (match) {
          return `<div class="memory-item">
            <span class="id">#${match[1]}</span>
            <span class="text">${match[2]}</span>
            <button class="delete-memory" data-id="${match[1]}">Delete</button>
          </div>`;
        }
        return '';
      }).join('');

      list.querySelectorAll('.delete-memory').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          await fetch("/chat", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ text: `/forget ${id}`, sessionId: currentSessionId })
          });
          await loadMemories();
          updateMemoryCount();
        };
      });
    }
  }

  document.getElementById("addMemoryBtn").onclick = async () => {
    const input = document.getElementById("newMemory");
    const text = input.value.trim();
    if (!text || !currentSessionId) return;

    await fetch("/chat", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ text: `/save ${text}`, sessionId: currentSessionId })
    });

    input.value = "";
    await loadMemories();
    updateMemoryCount();
  };

  async function updateMemoryCount() {
    try {
      const r = await fetch("/memory-count");
      const data = await r.json();
      document.getElementById("memoryCount").textContent = `${data.count} ${data.count === 1 ? 'memory' : 'memories'}`;
    } catch (e) {}
  }

  // Initialize
  loadSessions();
  updateMemoryCount();
</script>

<script type="module" src="./client.js"></script>
</body>
</html>
